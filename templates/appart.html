{% extends "layout.html" %}
{% block title %}Voir un appart{% endblock %}
{% block head %}
    {{ super() }}
    <script type="text/javascript" src="{{ url_for("static", filename="js/jquery.raty.js") }}"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            $('.score').raty({
                path:"{{ url_for("static", filename="images") }}",
                score:function () {
                    return $(this).attr('data-rating');
                },
                click:function (score, evt) {
                    if ($(this).attr("data-editable") == "true") {
                        $.post("{{ url_for("api_rate", appart_id=appart.id) }}", {"note":score});
                    }
                }
            });

            $(document).bind("mouseup", mouseUpHandler);
        });

        /*useful method to get selected text*/
        var getSelected = function () {
            var t = '';
            if (window.getSelection) {
                t = window.getSelection();
            } else if (document.getSelection) {
                t = document.getSelection();
            } else if (document.selection) {
                t = document.selection.createRange().text;
            }
            return t.toString();
        }

        var mouseUpHandler = function () {
            var selectedText = getSelected() + " " + {{ appart.cp }};
            var linkAgro=$("#linkAgro")
            var linkIntrin=$("#linkIntrin")

            linkAgro.attr("href", "http://www.ratp.fr/itineraires/fr/ratp/resultat-detaille/start/" + selectedText +
                    "/end/Rue+Claude+Bernard%2C+75005%2C+Paris/is_date_start/1/date/2013-04-02/time/08%3A00%3A00/route_type/plus_rapide");
            linkIntrin.attr("href", "http://www.ratp.fr/itineraires/fr/ratp/resultat-detaille/start/" + selectedText +
                    "/end/Avenue+Georges+Clemenceau%2C+92000%2C+Nanterre/is_date_start/1/date/2013-04-02/time/08%3A00%3A00/route_type/plus_rapide");

            linkAgro.find("img").attr("src", "{{ url_for("static",filename="images/agroparistech.jpg") }}");
            linkIntrin.find("img").attr("src", "{{ url_for("static",filename="images/intrin.jpg") }}");
        }
    </script>
{% endblock %}

{% block content %}
    <h1>{{ appart.titre }}</h1>
    <div>
        <div style="float:left; max-width:20%">
            <table>
                <tr>
                    <td>Loyer</td>
                    <td>{{ appart.loyer }} €</td>
                </tr>
                <tr>
                    <td>Ville</td>
                    <td>{{ appart.ville }}</td>
                </tr>
                <tr>
                    <td>CP</td>
                    <td>{{ appart.cp }}</td>
                </tr>
                <tr>
                    <td>Pièces</td>
                    <td>{{ appart.pieces }}</td>
                </tr>
                <tr>
                    <td style="padding-right:10px;">Meublé</td>
                    {% if appart.meuble %}
                        <td>Oui</td>
                    {% else %}
                        <td>Non</td>
                    {% endif %}
                </tr>
                <tr style="height:1em;vertical-align:bottom;">
                    <td>Surface</td>
                    <td>{{ appart.surface }} m<sup>2</sup></td>
                </tr>
                <tr>
                    <td>Date</td>
                    <td>{{ appart.date }}</td>
                </tr>
            </table>
            <br/>
            <a href="#" id="linkAgro"><img src="{{ url_for("static",filename="images/agroparistech_disabled.jpg") }}"/></a>
            <a href="#" id="linkIntrin"><img src="{{ url_for("static",filename="images/intrin_disabled.jpg") }}"/></a>
            {% if arrondissement %}
                <img src="{{ url_for("static",filename="images/arrdt_%s.gif" % arrondissement) }}"
                     style="max-width: 50%"/>
            {% endif %}
        </div>
        <div style="float:right; padding-left:15px; border-left-style: solid; width:75%">
            {{ appart.description|safe }}
        </div>
    </div>
    <div style="clear:both;"/>

    {% for photo in appart.photos %}
        <img src="{{ BASE_PHOTOS_URL }}{{ photo.file }}"/>
    {% endfor %}
    <br/>
    <a href="http://www.leboncoin.fr/locations/{{ appart.id }}.htm"><img
            src="{{ url_for("static", filename="images/leboncoin.png") }}"/></a>
    <br/>
    <hr/>
    <table>
        {% for view in appart.views %}
            {% if view.user == g.user %}
                <tr>
                    <td style="text-align:right">J'ai noté :</td>
                    <td><span class="score" data-editable="true" data-rating="{{ view.note }}"></span></td>
                </tr>

            {% elif view.note > 0 %}
                <tr>
                    <td style="text-align:right"><em>{{ view.user.username }}</em> a noté :</td>
                    <td><span class="score" data-rating="{{ view.note }}"></span></td>
                </tr>
            {% endif %}
        {% endfor %}
    </table>
    <br/>
    <hr/>
    {% for comment in appart.comments %}
        <p><em>{{ comment.user.username }}</em> le {{ comment.date }}</p>
        <blockquote>{{ comment.content }}</blockquote>
    {% endfor %}
    <form action="{{ url_for("comments_add") }}" method="post" id="commentForm">
        {{ form.hidden_tag() }}
        <p>
            Type your comment:<br>
            {{ form.content(maxlength=5000, rows=10, cols=100) }}<br>
        </p>

        <p><input type="submit" value="Submit"></p>
    </form>
{% endblock %}
